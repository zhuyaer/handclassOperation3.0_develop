<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Xenon Boostrap Admin Panel" />
    <meta name="author" content="" />

    <title>手播课运营平台</title>
    <link rel="Shortcut icon" href="../assets/images/icon-shouboke16.ico">

    <!--<link rel="stylesheet" href="http://fonts.useso.com/css?family=Arimo:400,700,400italic">-->
    <link rel="stylesheet" href="../assets/css/fonts/linecons/css/linecons.css">
    <link rel="stylesheet" href="../assets/css/fonts/fontawesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/css/bootstrap.css">
    <link rel="stylesheet" href="../assets/css/xenon-core.css">
    <link rel="stylesheet" href="../assets/css/xenon-forms.css">
    <link rel="stylesheet" href="../assets/css/xenon-components.css">
    <link rel="stylesheet" href="../assets/css/xenon-skins.css">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/css/index.css">
    <script src="../assets/js/jquery-1.11.1.min.js"></script>
    <script src="../assets/js/jquery.extend.js"></script>
    <script src="../assets/js/common.js"></script>
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<style>
    @media (min-width: 768px) {
        .container {
            width: 750px;
        }
    }
</style>
<body class="page-body">

<div class="settings-pane">

    <a href="#" data-toggle="settings-pane" data-animate="true">
        &times;
    </a>

    <div class="settings-pane-inner">

        <div class="row">

            <div class="col-md-4">

                <div class="user-info">

                    <div class="user-image">
                        <a href="extra-profile.html">
                            <img src="../assets/images/user-2.png" class="img-responsive img-circle" />
                        </a>
                    </div>

                    <div class="user-details">

                        <h3>
                            <a href="extra-profile.html">John Smith</a>

                            <!-- Available statuses: is-online, is-idle, is-busy and is-offline -->
                            <span class="user-status is-online"></span>
                        </h3>

                        <p class="user-title">Web Developer</p>

                        <div class="user-links">
                            <a href="../extra-profile.html" class="btn btn-primary">Edit Profile</a>
                            <a href="extra-profile.html" class="btn btn-success">Upgrade</a>
                        </div>

                    </div>

                </div>

            </div>

            <div class="col-md-8 link-blocks-env">

                <div class="links-block left-sep">
                    <h4>
                        <span>Notifications</span>
                    </h4>

                    <ul class="list-unstyled">
                        <li>
                            <input type="checkbox" class="cbr cbr-primary" checked="checked" id="sp-chk1" />
                            <label for="sp-chk1">Messages</label>
                        </li>
                        <li>
                            <input type="checkbox" class="cbr cbr-primary" checked="checked" id="sp-chk2" />
                            <label for="sp-chk2">Events</label>
                        </li>
                        <li>
                            <input type="checkbox" class="cbr cbr-primary" checked="checked" id="sp-chk3" />
                            <label for="sp-chk3">Updates</label>
                        </li>
                        <li>
                            <input type="checkbox" class="cbr cbr-primary" checked="checked" id="sp-chk4" />
                            <label for="sp-chk4">Server Uptime</label>
                        </li>
                    </ul>
                </div>

                <div class="links-block left-sep">
                    <h4>
                        <a href="#">
                            <span>Help Desk</span>
                        </a>
                    </h4>

                    <ul class="list-unstyled">
                        <li>
                            <a href="#">
                                <i class="fa-angle-right"></i>
                                Support Center
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fa-angle-right"></i>
                                Submit a Ticket
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fa-angle-right"></i>
                                Domains Protocol
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fa-angle-right"></i>
                                Terms of Service
                            </a>
                        </li>
                    </ul>
                </div>

            </div>

        </div>

    </div>

</div>

<nav class="navbar horizontal-menu navbar-fixed-top"><!-- set fixed position by adding class "navbar-fixed-top" -->

    <div class="navbar-inner">

        <!-- Navbar Brand -->
        <div class="navbar-brand">
            <a href="javascript:void(0)" class="logo">
                <img src="../assets/images/icon60.png" width="60" alt="" />
            </a>
        </div>

        <!-- main menu -->

        <ul class="navbar-nav">
            <li  class="opened active">
                <a href="index.html">
                    <i class="linecons-desktop"></i>
                    <span class="title">视频巡查</span>
                </a>
            </li>
        </ul>


        <!-- notifications and other links -->
        <ul class="nav nav-userinfo navbar-right">

            <!--<li>-->
                <!--<a href="#" data-toggle="settings-pane" data-animate="true">-->
                    <!--<i class="linecons-cog"></i>-->
                <!--</a>-->
            <!--</li>-->
            <li class="dropdown user-profile">
                <a href="#" data-toggle="dropdown">
                    <img src="../assets/images/user-4.png" alt="user-image" class="img-circle img-inline userpic-32" width="28" />
                        <span>
                            <span id="username"></span>
                            <i class="fa-angle-down"></i>
                        </span>
                </a>

                <ul class="dropdown-menu user-profile-menu list-unstyled" style="width:126px">
                    <li>
                        <a href="../editpwd.html" id="editpwd">
                            <i class="fa-eyedropper"></i>
                            修改密码
                        </a>
                    </li>
                    <li class="last">
                        <a href="../login.html" id="logout">
                            <i class="fa-lock"></i>
                            退出登录
                        </a>
                    </li>
                </ul>
            </li>
            <script>
                $(function(){
                    $("#username").html($.fn.getSession('username'));
                    $("#logout").click(function(){//退出登录保留记住的用户,密码,token过期
                        $.fn.setSession('token',null);
                    })
                })
            </script>
        </ul>

    </div>

</nav>

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->

    <div class="main-content">
            <!--Main-content-->
        <div class="row allvideo" style="margin:0">
            <div class="col-sm-1 active" id="live">直播</div>
            <div class="col-sm-1" id="over" style="margin-left: 15px;">回放</div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <!-- Removing search and results count filter -->
                <div class="panel panel-default" id="allTab">
                    <!--直播列表-->
                    <div id="liveList" class="panel-body">
                        <table class="table table-bordered table-striped" id="liveListTab">
                            <thead>
                            <tr>
                                <th>标题</th>
                                <th>课程性质</th>
                                <th>开课人</th>
                                <th>开课时间</th>
                                <th>视频</th>
                                <th>在线人数</th>
                                <th>被举报数</th>
                                <th>联系方式</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody id="liveListTbody" class="middle-align">
                            </tbody>
                        </table>
                    </div>
                    <!--回放列表-->
                    <div id="overList" class="panel-body">
                        <table class="table table-bordered table-striped" id="overListTab">
                            <thead>
                            <tr>
                                <th>标题</th>
                                <th>课程性质</th>
                                <th>开课人</th>
                                <th>开课时间</th>
                                <th>视频</th>
                                <th>观看数</th>
                                <th>被举报数</th>
                                <th>联系方式</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody id="overListTbody" class="middle-align">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Footer -->
        <footer class="main-footer footer-type-1">

            <div class="footer-inner">

                <!-- Add your copyright text here -->
                <div class="footer-text">
                    &copy; 2016
                    <strong>LYCAM+</strong>
                </div>


                <!-- Go to Top Link, just add rel="go-top" to any link to add this functionality -->
                <div class="go-up">

                    <a href="#" rel="go-top">
                        <i class="fa-angle-up"></i>
                    </a>

                </div>

            </div>
        </footer>
    </div>
</div>
</div>
<!--停止视频-->
<div class="modal fade" id="sureStopvideo">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">提示</h4>
            </div>
            <div class="modal-body">
                你确定要停止<span id="teamName"></span>的视频吗？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="suretoStopVideo" data-dismiss="modal">确定</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!--播放视频-->
<div class="modal fade" id="playThisVideo">
    <div class="modal-dialog">
        <button type="button" style="position: relative;right:-10px" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <div class="modal-content" id="video">
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!--举报图片详情-->
<div class="modal fade" id="viewpicDetail" style="z-index: 3000">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">举报图片</h4>
            </div>
            <div class="modal-body">
                <img id="imgOfReport" style="width: 100%" src=""/>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<div class="modal fade" id="viewDetail">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">视频举报详情</h4>
            </div>
            <div class="modal-body">
                <table id="reportTable" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    <thead>
                    <tr>
                        <th>举报人</th>
                        <th>举报原因</th>
                        <th>截图</th>
                        <th>举报时间</th>
                        <th>联系方式</th>
                    </tr>
                    </thead>
                    <tbody id="reportTbody">
                    </tbody>
                </table>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript">
    $(function(){
        var _this={};
        _this.socketArrs=[];
        _this.status='live'
        //初始化视频
        _this.player = flowplayer($("#video"),{
            splash: true,
            ratio:0.4167,
            autoplay:true,
            adaptiveRatio: true,
            swf: 'http://handsclass.oss-cn-shenzhen.aliyuncs.com/assets/flowplayer/flowplayer.swf',
            swfHls: 'http://handsclass.oss-cn-shenzhen.aliyuncs.com/assets/flowplayer/flowplayerhls.swf',
            clip: {
                sources: [
                    { type:"",
                        src:"" }
                ]
            }
        });

        /*****************分配视频表*****************/

        $("#overList").hide()
        $("#liveList").show()
        $(".allvideo").on("click","div",function(){
            $('#playThisVideo').modal('hide');
            $(".allvideo div.active")&&$(".allvideo div.active").removeClass("active");
            $(this).addClass("active");
            var id=$(this).attr("id");
            $("#overList").hide();
            $("#liveList").hide();
            $("#"+id+"List").show();
            _this.status=id
        });

        //获取列表
        getoverList();
        getliveList();

        //查看视频
        $("#allTab").on('click','.tabImg img',function(){
            var url=$(this).attr("videoUrls");
            console.log("url",url)
            if(_this.status='over'){
                _this.player.load({
                    sources: [
                        { type: "application/x-mpegurl", src: url }
                    ]
                });
            }else{
                _this.player.load({
                    sources: [
                        { type: "video/flash", src: url }
                    ]
                });
            }

        });
        $("#playThisVideo").on('hidden.bs.modal',function(){
            _this.player.stop();
            _this.player.unload();
        })

        //查看举报
        $("#allTab").on('click','.reportInfo',function(){
            reportList($(this).attr('report'))
        })
        $("#viewDetail").on('hidden.bs.modal',function(){
            _this.reportTab&&_this.reportTab.destroy();
        })
        //查看举报图片详情
        $("#viewDetail").on('click','.reportImgBox',function(){
            var src=$(this).find('img').attr('src')
            console.log('src',src)
            $("#imgOfReport").attr("src",src)
        })
        //停止视频
        $("#allTab").on('click','.stopVideo',function(){
            var teamName=$(this).parent().parent().find('td:first-child').text();
            $("#teamName").text(teamName)
            _this.toStopVideoId=$(this).attr('id')
        });
        $("#suretoStopVideo").on('click',function(){
            stopRow()
        })

        function socket(){
            var socket = io.connect($.socketHttp+"/report");
            socket.on('connect',function(){
                console.log('connected')
                console.log(" _this.socketArrs", _this.socketArrs)
                socket.emit('init', _this.socketArrs)
            })
            socket.on('report',function(data){
                console.log("reportData",data)
                for(var i=0;i<data.length;i++){
                    $("#report"+data[i]._id).html(data[i].count)
                }

            });
            socket.on('online-user',function(data){
                console.log("online",data)
                $("#online"+data.streamId).html(data.count)
            });
        }
        function stopRow(){
            $.ajax({
                type:'POST',
                data:{},
                headers:{
                    access_token:$.fn.getSession('token')
                },
                url:$.severHttp+"/cop/stream/"+_this.toStopVideoId+"/stop",
                success:function(data){
                    if(data>0){
                        var hasStop='<button type="button" class="btn btn-primary btn-sm btn-icon icon-left disabled">已停止</button>';
                        $("#"+_this.toStopVideoId).parent().html(hasStop)

                        toastr.success("视频已经停止!");
                    }else{
                        toastr.error("视频停止失败!");
                    }
                },
                error:function(error){
                    console.log('error',error);
                    toastr.error("视频停止失败!");
                }
            })
        }
        function getoverList(){
            _this.tabOver=$("#overListTab").DataTable({
                //默认以某列来排序
                serverSide:true,
                order: [[ 2, "desc" ]],
                aLengthMenu: paging,
//            processing : true,
                oLanguage:totableZHTitle,
                columns:[
                    {data:'title',orderable:false},
                    {data:'privacy',render:function(data,type,full,meta){
                        if(data){
                            return "团队课"
                        }else{
                            return "公开课"
                        }
                    }},
                    {data:'userName',orderable:false},
                    {data:'timeStarted',render:function(data,type,full,meta){
                        return data=formatDate(data,'yyyy-MM-dd HH:mm')
                    }},
                    {data:'thumbnailUrl',orderable:false,render:function(data,type,full,meta){
                        console.log("over",full)
                        return data='<div class="tabImg"><img id="img'+full.streamId+'" data-toggle="modal" data-target="#playThisVideo"  ' +
                        'videoUrls="'+full.streamUrls[0].url+'" src="'+data+'"/></div>'
                    }},
                    {data:'watchedCount'},//观看数
                    {data:'informCount',render:function(data,type,full,meta){//举报数
                        return data='<div class="reportInfo" report="'+full.streamId+'" data-toggle="modal" data-target="#viewDetail">'+data+'</div>'
                    }},
                    {data:'title',orderable:false,render:function(data,type,full,meta){
                        return data=full.userPhone?full.userPhone:""
                    }},
                    {data:'streamId',orderable:false,render:function(data,type,full,meta){
                        if(full.illegal){
                            return data='<button type="button" class="btn btn-primary btn-sm btn-icon icon-left disabled">已停止</button>'
                        }
                        return data='<button type="button" id='+data+' data-toggle="modal" data-target="#sureStopvideo" class="btn stopVideo btn-blue btn-sm btn-icon icon-left">停止</button>'
                    }}
                ],
                //设置tr属性
                fnCreatedRow: function( nRow, aData, iDataIndex ) {
                    $(nRow).attr('id',"row"+aData.streamId);
                },
                ajax:{
                    url:$.severHttp+"/stream/list?status=over",
                    headers:{
                        access_token:$.fn.getSession('token')
                    }
                }
            });
        }
        function getliveList(){
            _this.tabLive=$("#liveListTab").DataTable({
                //默认以某列来排序
                serverSide:true,
                order: [[ 2, "desc" ]],
                aLengthMenu: paging,
                oLanguage:totableZHTitle,
//            processing : true,
                columns:[
                    {data:'title',orderable:false},
                    {data:'privacy',render:function(data,type,full,meta){
                        if(data){
                            return "团队课"
                        }else{
                            return "公开课"
                        }
                    }},
                    {data:'userName',orderable:false},
                    {data:'timeStarted',render:function(data,type,full,meta){
                        return data=formatDate(data,'yyyy-MM-dd HH:mm')
                    }},
                    {data:'thumbnailUrl',orderable:false,render:function(data,type,full,meta){
//                        console.log("live",full)
                        return data='<div class="tabImg"><img id="img'+full.streamId+'" data-toggle="modal" data-target="#playThisVideo"  videoUrls="'+full.streamUrls[0].url+'" src="'+data+'"/></div>'
                    }},
                    {data:'audiences',orderable:false,render:function(data,type,full,meta){//在线人数(数据不来自数据库，只能客户端排序但不能一次性获取全部数据不能排序)
                        _this.socketArrs.push({stream:full.streamId,chatChannel:full.chatChannel})
                        return data='<span id="online'+full.streamId+'"+>'+data+'</span>'
                    }},
                    {data:'informCount',render:function(data,type,full,meta){//举报数
                        return data='<div class="reportInfo" id="report'+full.streamId+'" report="'+full.streamId+'" data-toggle="modal" data-target="#viewDetail">'+data+'</div>'
                    }},
                    {data:'title',orderable:false,render:function(data,type,full,meta){
                        return data=full.userPhone?full.userPhone:""
                    }},
                    {data:'streamId',orderable:false,render:function(data,type,full,meta){
                        return data='<button type="button" id='+data+' data-toggle="modal" data-target="#sureStopvideo" class="btn stopVideo btn-blue btn-sm btn-icon icon-left">停止</button>'
                    }}
                ],
                fnCreatedRow: function( nRow, aData, iDataIndex ) {
                    $(nRow).attr('id',"row"+aData.streamId);
                },
                fnDrawCallback:function(oSettings){//获取后台方式 直接可以拿到json 之后进行处理
                    socket();
                },
                ajax:{
                    url:$.severHttp+"/stream/list?status=live",
                    headers:{
                        access_token:$.fn.getSession('token')
                    }
                }
            });
        }
        function reportList(streamId){
            $.ajax({
                type:'GET',
                headers:{
                    access_token:$.fn.getSession('token')
                },
                url:$.severHttp+"/stream/report?streamId="+streamId,
                success:function(data){
                    console.log("data",data)
                    var tab='';
                    for(var i=0;i<data.length;i++){
                        tab+='<tr>' +
                        '<td>'+data[i].displayName+'</td>'+
                        '<td>'+data[i].reason+'</td>'+
                        '<td><div class="reportImgBox"><img data-toggle="modal" data-target="#viewpicDetail" src="'+data[i].picUrl+'"/></div></td>'+
                        '<td>'+formatDate(data[i].createdAt,'yyyy-MM-dd HH:mm')+'</td>'+
                        '<td>'+(function(){return data[i].contact?data[i].contact:"无"})()+'</td>'+
//                        '<td>'+data[i].contact+'</td>'+
                        '</tr>'
                    }
                    $("#reportTbody").html(tab)
                    _this.reportTab=$("#reportTable").DataTable({
                        dom: "t" + "<'row'<'col-xs-6'i><'col-xs-6'p>>",
                        aLengthMenu: paging,
                        aoColumns: [
                            null,
                            null,
                            {bSortable: false},
                            null,
                            {bSortable: false}
                        ],
                        oLanguage:totableZH
                    });
                },
                error:function(error){}
            })
        }
    })
</script>

<!-- Imported styles on this page -->
<link rel="stylesheet" href="../assets/css/fonts/meteocons/css/meteocons.css">

<!-- Bottom Scripts -->
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/TweenMax.min.js"></script>
<script src="../assets/js/resizeable.js"></script>
<script src="../assets/js/joinable.js"></script>
<script src="../assets/js/xenon-api.js"></script>
<script src="../assets/js/xenon-toggles.js"></script>


<!--<script src="assets/js/xenon-widgets.js"></script>-->
<!-- Imported scripts on this page -->
<script src="../assets/js/socket.io.js"></script>
<script src="../assets/js/toastr/toastr.min.js"></script>

<!--<script src="../assets/js/async/dist/async.min.js"></script>-->
<!--绘制表格-->
<script src="../assets/js/datatables/js/jquery.dataTables.min.js"></script>
<script src="../assets/js/datatables/dataTables.bootstrap.js"></script>
<script src="../assets/js/datatables/yadcf/jquery.dataTables.yadcf.js"></script>
<script src="../assets/js/datatables/tabletools/dataTables.tableTools.min.js"></script>


<!--flowplayer-->
<link rel="stylesheet" href="flowplayer/skin/functional.css">
<script src="flowplayer/flowplayer.min.js"></script>

<!-- Imported styles on this page -->

<!-- JavaScripts initializations and stuff -->
<script src="../assets/js/xenon-custom.js"></script>


</body>
</html>