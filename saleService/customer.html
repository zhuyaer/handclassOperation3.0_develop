<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Xenon Boostrap Admin Panel" />
    <meta name="author" content="" />

    <title>手播课运营平台</title>
    <link rel="Shortcut icon" href="../assets/images/icon-shouboke16.ico">

    <!--<link rel="stylesheet" href="http://fonts.useso.com/css?family=Arimo:400,700,400italic">-->
    <link rel="stylesheet" href="../assets/css/fonts/linecons/css/linecons.css">
    <link rel="stylesheet" href="../assets/css/fonts/fontawesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/css/bootstrap.css">
    <link rel="stylesheet" href="../assets/css/xenon-core.css">
    <link rel="stylesheet" href="../assets/css/xenon-forms.css">
    <link rel="stylesheet" href="../assets/css/xenon-components.css">
    <link rel="stylesheet" href="../assets/css/xenon-skins.css">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/css/index.css">
    <script src="../assets/js/jquery-1.11.1.min.js"></script>
    <script src="../assets/js/jquery.extend.js"></script>
    <script src="../assets/js/common.js"></script>
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body class="page-body">

<div class="settings-pane">

    <a href="#" data-toggle="settings-pane" data-animate="true">
        &times;
    </a>

    <div class="settings-pane-inner">

        <div class="row">

            <div class="col-md-4">

                <div class="user-info">

                    <div class="user-image">
                        <a href="extra-profile.html">
                            <img src="../assets/images/user-2.png" class="img-responsive img-circle" />
                        </a>
                    </div>

                    <div class="user-details">

                        <h3>
                            <a href="extra-profile.html">John Smith</a>

                            <!-- Available statuses: is-online, is-idle, is-busy and is-offline -->
                            <span class="user-status is-online"></span>
                        </h3>

                        <p class="user-title">Web Developer</p>

                        <div class="user-links">
                            <a href="../extra-profile.html" class="btn btn-primary">Edit Profile</a>
                            <a href="extra-profile.html" class="btn btn-success">Upgrade</a>
                        </div>

                    </div>

                </div>

            </div>

            <div class="col-md-8 link-blocks-env">

                <div class="links-block left-sep">
                    <h4>
                        <span>Notifications</span>
                    </h4>

                    <ul class="list-unstyled">
                        <li>
                            <input type="checkbox" class="cbr cbr-primary" checked="checked" id="sp-chk1" />
                            <label for="sp-chk1">Messages</label>
                        </li>
                        <li>
                            <input type="checkbox" class="cbr cbr-primary" checked="checked" id="sp-chk2" />
                            <label for="sp-chk2">Events</label>
                        </li>
                        <li>
                            <input type="checkbox" class="cbr cbr-primary" checked="checked" id="sp-chk3" />
                            <label for="sp-chk3">Updates</label>
                        </li>
                        <li>
                            <input type="checkbox" class="cbr cbr-primary" checked="checked" id="sp-chk4" />
                            <label for="sp-chk4">Server Uptime</label>
                        </li>
                    </ul>
                </div>

                <div class="links-block left-sep">
                    <h4>
                        <a href="#">
                            <span>Help Desk</span>
                        </a>
                    </h4>

                    <ul class="list-unstyled">
                        <li>
                            <a href="#">
                                <i class="fa-angle-right"></i>
                                Support Center
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fa-angle-right"></i>
                                Submit a Ticket
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fa-angle-right"></i>
                                Domains Protocol
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fa-angle-right"></i>
                                Terms of Service
                            </a>
                        </li>
                    </ul>
                </div>

            </div>

        </div>

    </div>

</div>

<nav class="navbar horizontal-menu navbar-fixed-top"><!-- set fixed position by adding class "navbar-fixed-top" -->

    <div class="navbar-inner">

        <!-- Navbar Brand -->
        <div class="navbar-brand">
            <a href="javascript:void(0)" class="logo">
                <img src="../assets/images/icon60.png" width="60" alt="" />
            </a>
        </div>

        <!-- main menu -->

        <ul class="navbar-nav">
            <li>
                <a href="potential.html">
                    <i class="linecons-desktop"></i>
                    <span class="title">潜在客户</span>
                </a>
            </li>
            <li>
                <a href="maintenance.html">
                    <i class="linecons-note"></i>
                    <span class="title">已消费客户</span>
                </a>
            </li>
            <li class="opened active">
                <a href="customer.html">
                    <i class="linecons-cloud"></i>
                    <span class="title">经销商管理</span>
                </a>
            </li>
            <li>
                <a href="feedback.html">
                    <i class="linecons-pencil"></i>
                    <span class="title">意见反馈</span>
                </a>
            </li>
        </ul>


        <!-- notifications and other links -->
        <ul class="nav nav-userinfo navbar-right">

            <!--<li>-->
            <!--<a href="#" data-toggle="settings-pane" data-animate="true">-->
            <!--<i class="linecons-cog"></i>-->
            <!--</a>-->
            <!--</li>-->
            <li class="dropdown user-profile">
                <a href="#" data-toggle="dropdown">
                    <img src="../assets/images/user-4.png" alt="user-image" class="img-circle img-inline userpic-32" width="28" />
                        <span>
                            <span id="username"></span>
                            <i class="fa-angle-down"></i>
                        </span>
                </a>

                <ul class="dropdown-menu user-profile-menu list-unstyled" style="width:126px">
                    <li>
                        <a href="../editpwd.html" id="editpwd">
                            <i class="fa-eyedropper"></i>
                            修改密码
                        </a>
                    </li>
                    <li class="last">
                        <a href="../login.html" id="logout">
                            <i class="fa-lock"></i>
                            退出登录
                        </a>
                    </li>
                </ul>
            </li>
            <script>
                $(function(){
                    $("#username").html($.fn.getSession('username'));
                    $("#logout").click(function(){//退出登录保留记住的用户,密码,token过期
                        $.fn.setSession('token',null);
                    })
                })
            </script>
        </ul>

    </div>

</nav>

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->

    <div class="main-content">

        <!--老客户群-->

        <div class="row">
            <div class="col-sm-12">
                <!-- Removing search and results count filter -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">经销商</h3>
                    </div>
                    <div class="panel-body">
                        <table id="maintenanceTable" class="table table-striped table-bordered" cellspacing="0" width="100%">
                            <thead>
                            <tr>
                                <th>公司名称</th>
                                <th>行业类型</th>
                                <th>联系人</th>
                                <th class="no-sorting">卡券信息</th>
                                <th class="no-sorting">订单详情</th>
                                <th class="no-sorting">手机号</th>
                                <th>注册时间</th>
                                <th>邮箱</th>
                                <th>邮寄地址</th>
                                <th>折扣(%)</th>
                            </tr>
                            </thead>
                            <tbody id="maintenanceTable_tab">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Footer -->
        <footer class="main-footer footer-type-1">

            <div class="footer-inner">

                <!-- Add your copyright text here -->
                <div class="footer-text">
                    &copy; 2016
                    <strong>LYCAM+</strong>
                </div>


                <!-- Go to Top Link, just add rel="go-top" to any link to add this functionality -->
                <div class="go-up">

                    <a href="#" rel="go-top">
                        <i class="fa-angle-up"></i>
                    </a>

                </div>

            </div>

        </footer>
    </div>

</div>
</div>
<!--设置折扣-->
<div class="modal fade" id="setDiscount">
    <div class="modal-dialog" style="width:600px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">修改折扣(%)</h4>
            </div>
            <div class="modal-body">
                <div class="row" style="text-align: center;margin-bottom: 20px">
                    <span class="sellerName"></span>
                </div>
                <div class="row">
                    <div style="margin:0 auto;margin-bottom: 20px" class="input-group input-group-sm spinner col-sm-6" data-step="5" data-min="0" data-max="100">
                        <span class="input-group-btn">
                            <button class="btn btn-turquoise btn-single" data-type="decrement">-</button>
                        </span>
                            <input type="text" class="form-control text-center no-left-border" value="0"/>
                        <span class="input-group-btn">
                            <button class="btn btn-turquoise btn-single" data-type="increment">+</button>
                        </span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <button type="button" id="setSaveBtn" data-dismiss="modal" class="btn btn-turquoise">保存设置</button>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!--查看卡券-->
<div class="modal fade" id="forCard">
    <div class="modal-dialog" style="width:800px;">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">卡券信息</h4>
            </div>
            <div class="modal-body">
                <table id="cardTable" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    <thead>
                    <tr>
                        <th>卡券号</th>
                        <th>面额(元)</th>
                        <th>发放日期</th>
                        <th>使用情况</th>
                    </tr>
                    </thead>
                    <tbody id="cardTbody">
                    </tbody>
                </table>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!--订单详情-->
<div class="modal fade" id="forOrder">
    <div class="modal-dialog"  style="width:950px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">订单信息</h4>
            </div>
            <div class="modal-body">
                <table id="orderTable" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    <thead>
                    <tr>
                        <th>订单号</th>
                        <th>充值金额(元)</th>
                        <th>充值方式</th>
                        <th>充值状态</th>
                        <th>充值确认</th>
                        <th>充值时间</th>
                    </tr>
                    </thead>
                    <tbody id="orderTbody">
                    </tbody>
                </table>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript">
    $(function(){
        var _this={}
        getusers()
        //团队详情
        $("#maintenanceTable").on("click",".setcount",function(){
            _this.setCountId=$(this).parent().parent().attr("id");
            _this.setCountVal=$(this).prev().text();
            _this.setCountnum=$("#"+_this.setCountId).find("td:nth-child(6)").text();
            _this.setCountName=$("#"+_this.setCountId).find("td:nth-child(3)").text();
            var obj=null;
            if(_this.setCountName=="无"){
                obj='<span>'+ _this.setCountnum+'</span>'
            }else{
                obj='<span>'+_this.setCountName+'('+_this.setCountnum+')</span>'
            }
            $(".sellerName").html(obj)
            $("#setDiscount input.form-control").val(_this.setCountVal)
        });
        //查看卡券信息
        $("#maintenanceTable").on("click",".forCard",function(){
            var sellerId=$(this).parent().parent().attr('id');
            getCards(sellerId)
        })
        //查看订单记录
        $("#maintenanceTable").on("click",".forOrder",function(){
            var sellerId=$(this).parent().parent().attr('id');
            gettrade(sellerId)
        })
        $("#forCard").on('hidden.bs.modal',function(){
            _this.cardTable&&_this.cardTable.destroy();
        })
        $("#forOrder").on('hidden.bs.modal',function(){
            _this.orderTable&&_this.orderTable.destroy();
        })
        $("#setSaveBtn").click(function(){
            setCount()
        });

        //人工确认银行转账
        $("#orderTable").on("click",".suretTransfer",function(){
            var out_trade_no=$(this).parent().parent().attr("id");
            var dealer=$(this).parent().parent().find("td:first-child").attr('id');
            suretTransfer(dealer,out_trade_no)
        })
        function getusers(){
            $.ajax({
                type:'GET',
                data:{},
                headers:{
                    access_token:$.fn.getSession('token')
                },
                url:$.severHttp+"/seller/dealer/list?seller="+$.fn.getSession('sellerId'),
                success:function(data){
//                    console.log("经销商",data)
                    var tab='';
                    var idArr=[];
                    for(var i=0;i<data.length;i++){
                        tab+=
                            '<tr id="'+data[i].id+'" class="point'+data[i].id+'">' +
                            '<td>'+(data[i].company?data[i].company:"无")+'</td>'+
                            '<td>'+(data[i].industry?data[i].industry:"无")+'</td>'+
                            '<td>'+(data[i].contact?data[i].contact:"无")+'</td>'+
                            '<td><span class="label label-success forCard" data-toggle="modal" data-target="#forCard">查看卡券</span></td>'+
                            '<td><span class="label label-success forOrder" data-toggle="modal" data-target="#forOrder">查看订单</span></td>'+
                            '<td>'+data[i].phone+'</td>'+
                            '<td>'+formatDate(data[i].updatedAt,'yyyy-MM-dd HH:mm')+'</td>'+
                            '<td>'+(data[i].email?data[i].email:"无")+'</td>'+
                            '<td>'+(data[i].mailingAddress?data[i].mailingAddress:"无")+'</td>' +
                            '<td><span>'+data[i].discount+'</span>' +
                            '<span style="margin-left:10px;" class="label label-success setcount" data-toggle="modal" data-target="#setDiscount">修改</span>'+
                            '</td></tr>'
                        idArr.push(data[i].id)
                    }
                    $("#maintenanceTable_tab").html(tab)
                    _this.setCountTable=$("#maintenanceTable").DataTable({
                        //  dom: "t" + "<'row'<'col-xs-6'i><'col-xs-6'p>>",
                        order: [[ 6, "desc" ]],
                        aLengthMenu: paging,
                        bProcessing : true,
                        aoColumns: [
                            null,
                            null,
                            null,
                            {bSortable: false},
                            {bSortable: false},
                            {bSortable: false},
                            null,
                            null,
                            null,
                            null
                        ],
                        oLanguage:totableZH
                    });
                    if(i==data.length){
                        needtoSure(idArr)
                    }

                },
                error:function(error){

                }
            })
        }
        //标记所有需要人工确认的订单
        function needtoSure(idArr){
            for(var i=0;i<idArr.length;i++){
                var _thisId=idArr[i];
                (function(id){
                    $.ajax({
                        type: 'GET',
                        data: {
                            page:1,
                            resultsPerPage:10000
                        },
                        headers: {
                            access_token: $.fn.getSession('token')
                        },
                        url: $.severHttp + "/trade/list?dealer="+id,
                        success: function (data) {
                        var dta=data.items;
                            dta.forEach(function(t,n){
                                if(t.trade_type=="bank-transfer"&&t.status=="prepare"){
                                    $(".point"+id).find("td:nth-child(5) span").css("background","red")
                                }
                            })
                        },
                        error: function (error) {

                        }
                    })
                })(_thisId)

            }
        }
        function setCount(){
            $.ajax({
                type:'GET',
                data:{
                   discount: $("#setDiscount input.form-control").val()||100,
                    dealer:_this.setCountId
                },
                headers:{
                    access_token:$.fn.getSession('token')
                },
                url:$.severHttp+"/dealer/setDiscount",
                success:function(data){
                    if(data.success){
                        toastr.success("修改成功！")
                        $("#"+_this.setCountId).find("td:last-child span:eq(0)").text($("#setDiscount input.form-control").val()||100);
                    }else{
                        toastr.error("修改失败！")
                    }
                },
                error:function(){
                    toastr.error("修改失败！")
                }
            })
        }
        function getCards(id){
            console.log("id",id)
            $.ajax({
                type: 'GET',
                data: {
                    page:1,
                    resultsPerPage:10000
                },
                headers: {
                    access_token: $.fn.getSession('token')
                },
                url: $.severHttp + "/voucher/list?dealer="+id,
                success: function (data) {
                    console.log("卡券信息",data)
                    var data=data.items;
                    var tab='';
                    for(var i=0;i<data.length;i++){
                        tab+=
                            '<tr>'+
                            '<td>'+data[i].voucherId+'</td>'+
                            '<td>'+data[i].value+'</td>'+
                            '<td>'+formatDate(data[i].createdAt,'yyyy-MM-dd HH:mm')+'</td>'+
                            '<td>'+(data[i].isUsed?'<span class="label label-red">已使用</span>':'<span class="label label-secondary">未使用</span>')+'</td>'+
                            '</tr>'
                    }
                    $("#cardTbody").html(tab)
                    _this.cardTable=$("#cardTable").DataTable({
                        //  dom: "t" + "<'row'<'col-xs-6'i><'col-xs-6'p>>",
                        order: [[ 2, "desc" ]],
                        aLengthMenu: paging,
                        bProcessing : true,
                        aoColumns: [
                            {"sWidth": "30%"},
                            {"sWidth": "20%"},
                            {"sWidth": "30%"},
                            {"sWidth": "20%"}
                        ],
                        oLanguage:totableZH
                    });

                },
                error: function (error) {

                }
            })
        }
        function gettrade(id){
            $.ajax({
                type: 'GET',
                data: {
                    page:1,
                    resultsPerPage:10000
                },
                headers: {
                    access_token: $.fn.getSession('token')
                },
                url: $.severHttp + "/trade/list?dealer="+id,
                success: function (data) {
                    console.log("订单信息",data)
                    var data=data.items
                    var tab='';
                    for(var i=0;i<data.length;i++){
                        tab+=
                        '<tr id="'+data[i].out_trade_no+'">'+
                        '<td id="'+data[i].dealer+'">'+data[i].out_trade_no+'</td>'+
                        '<td>'+data[i].total_amount+'</td>'+
                        '<td>'+trade_type(data[i].trade_type)+'</td>'+
                        '<td>'+status(data[i].status)+'</td>'+
                        '<td style="text-align: center">'+surePay(data[i].trade_type,data[i].status,data[i].extraInfo)+'</td>'+
                        '<td>'+formatDate(data[i].createdAt,'yyyy-MM-dd HH:mm')+'</td>'+
                        '</tr>'
                    }
                    $("#orderTbody").html(tab)
                    _this.orderTable=$("#orderTable").DataTable({
                        //  dom: "t" + "<'row'<'col-xs-6'i><'col-xs-6'p>>",
                        order: [[ 5, "desc" ]],
                        aLengthMenu: paging,
                        bProcessing : true,
                        aoColumns: [
                            {"sWidth": "20%"},
                            {"sWidth": "15%"},
                            {"sWidth": "15%"},
                            {"sWidth": "15%"},
                            {"sWidth": "15%"},
                            {"sWidth": "20%"}
                        ],
                        oLanguage:totableZH
                    });
                },
                error: function (error) {

                }
            })
        }
        function suretTransfer(dealer,out_trade_no){
            $.ajax({
                type: 'POST',
                data: {
                    out_trade_no:out_trade_no,
                    dealer:dealer
                },
                headers: {
                    access_token: $.fn.getSession('token')
                },
                url: $.severHttp + "/pay/bank/ensure",
                success: function (data) {
                    if(data.success){
                        var obj='<button class="btn btn-blue disabled">'+data.ensureUsername+'已确认</button>';
                        $("#"+out_trade_no).find("td:nth-child(5)").html(obj)
                        $("#"+out_trade_no).find("td:nth-child(4)").text("支付成功")
                        toastr.success("确认转账成功！")
                    }else{
                        toastr.error("确认失败！")
                    }
                },
                error: function (error) {
                    toastr.error("确认失败！")
                }
            })
        }
        function trade_type(trade){
            if(trade=="bank-transfer"){
                return "银行转账"
            }else if(trade=="alipay"){
                return "支付宝支付"
            }else{
                return "微信支付"
            }
        }
        function status(status){
            if(status=="prepare"){
                return "未支付"
            }else if(status=="success"){
                return "支付成功"
            }else{
                return "支付失败"
            }
        }
        function surePay(trade,status,extraInfo){
            if(trade=="bank-transfer"&&status=="prepare"){
                return '<button class="btn btn-blue suretTransfer">点击确认</button>'
            }else if(trade=="bank-transfer"&&status=="success"){
                return '<button class="btn btn-blue disabled">'+(extraInfo.ensureUsername?extraInfo.ensureUsername:"")+'已确认</button>'
            }else{
                return '——'
            }
        }
    })
</script>

<!-- Imported styles on this page -->
<link rel="stylesheet" href="../assets/css/fonts/meteocons/css/meteocons.css">

<!-- Bottom Scripts -->
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/TweenMax.min.js"></script>
<script src="../assets/js/resizeable.js"></script>
<script src="../assets/js/joinable.js"></script>
<script src="../assets/js/xenon-api.js"></script>
<script src="../assets/js/xenon-toggles.js"></script>

<!--<script src="../assets/js/xenon-widgets.js"></script>-->
<!--<script src="../assets/js/devexpress-web-14.1/js/globalize.min.js"></script>-->
<!--<script src="../assets/js/devexpress-web-14.1/js/dx.chartjs.js"></script>-->
<script src="../assets/js/toastr/toastr.min.js"></script>

<!--绘制表格-->
<script src="../assets/js/datatables/js/jquery.dataTables.min.js"></script>
<script src="../assets/js/datatables/dataTables.bootstrap.js"></script>
<script src="../assets/js/datatables/yadcf/jquery.dataTables.yadcf.js"></script>
<script src="../assets/js/datatables/tabletools/dataTables.tableTools.min.js"></script>


<!-- JavaScripts initializations and stuff -->
<script src="../assets/js/xenon-custom.js"></script>


</body>
</html>